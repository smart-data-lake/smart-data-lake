<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-getting-started/part-3/custom-webservice">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Smart Data Lake Builder RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Smart Data Lake Builder Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Smart Data Lake Builder" href="/opensearch.xml"><title data-rh="true">Custom Webservice | Smart Data Lake Builder</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.smartdatalake.ch/docs/getting-started/part-3/custom-webservice"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Custom Webservice | Smart Data Lake Builder"><meta data-rh="true" name="description" content="Goal"><meta data-rh="true" property="og:description" content="Goal"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.smartdatalake.ch/docs/getting-started/part-3/custom-webservice"><link data-rh="true" rel="alternate" href="https://www.smartdatalake.ch/docs/getting-started/part-3/custom-webservice" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.smartdatalake.ch/docs/getting-started/part-3/custom-webservice" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://UOM3ZOMCU0-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.0f640fc3.css">
<link rel="preload" href="/assets/js/runtime~main.c7df9dc1.js" as="script">
<link rel="preload" href="/assets/js/main.e0a979e5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/sdl_logo.png" alt="Smart Data Lake Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/sdl_logo.png" alt="Smart Data Lake Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Smart Data Lake</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/JsonSchemaViewer">SchemaViewer</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/smart-data-lake/smart-data-lake" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/">Smart Data Lake</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/getting-started/setup">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/setup">Technical Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/get-input-data">Inputs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/getting-started/part-1/get-departures">Part 1</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/getting-started/part-2/industrializing">Part 2</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/getting-started/part-3/custom-webservice">Part 3</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/getting-started/part-3/custom-webservice">Custom Webservice</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/part-3/incremental-mode">Incremental Mode</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/getting-started/troubleshooting/common-problems">Troubleshooting</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/reference/build">Reference</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/JsonSchemaViewer">Configuration Schema Viewer</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Getting Started</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Part 3</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Custom Webservice</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Custom Webservice</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="goal">Goal<a class="hash-link" href="#goal" title="Direct link to heading">​</a></h2><p>  In the previous examples we worked mainly with data that was available as a file or could be fetched with the built-in <code>WebserviceFileDataObject</code>.
To fetch data from a webservice, the <code>WebserviceFileDataObject</code> is sometimes not enough and has to be customized.
The reasons why the built-in DataObject is not sufficient are manifold, but it&#x27;s connected to the way Webservices are designed.
Webservices often include design features like: </p><ul><li>data pagination</li><li>protect resources using rate limiting </li><li>different authentication mechanisms</li><li>filters for incremental load</li><li>well defined schema</li><li>...</li></ul><p>Smart Data Lake Builder can not cover all these various needs in a generic <code>WebserviceDataObject</code>, which is why we have to write our own <code>CustomWebserviceDataObject</code>.
The goal of this part is to learn how such a CustomWebserviceDataObject can be implemented in Scala.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>Other than part 1 and 2, we are writing customized Scala classes in part 3 and making use of Apache Spark features.
As such, we expect you to have some Scala and Spark know-how to follow along.</p><p>It is also a good idea to configure a working development environment at this point.
In the <a href="/docs/getting-started/setup">Technical Setup</a> chapter we briefly introduced how to use IntelliJ for development.
That should greatly improve your development experience compared to manipulating the file in a simple text editor.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="starting-point">Starting point<a class="hash-link" href="#starting-point" title="Direct link to heading">​</a></h2><p>Again we start with the <code>application.conf</code> that resulted from finishing the last part.
If you don&#x27;t have the application.conf from part 2 anymore, please copy <a target="_blank" href="/assets/files/application-part2-historical-62b47cb172772c79ba8f08c7082ca360.conf">this</a> configuration file to <strong>config/application.conf</strong> again.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="define-data-objects">Define Data Objects<a class="hash-link" href="#define-data-objects" title="Direct link to heading">​</a></h2><p>We start by rewriting the existing <code>ext-departures</code> DataObject.
In the configuration file, replace the old configuration with its new definition:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ext-departures {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = CustomWebserviceDataObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  schema = &quot;&quot;&quot;array&lt; struct&lt; icao24: string, firstSeen: integer, estDepartureAirport: string, lastSeen: integer, estArrivalAirport: string, callsign: string, estDepartureAirportHorizDistance: integer, estDepartureAirportVertDistance: integer, estArrivalAirportHorizDistance: integer, estArrivalAirportVertDistance: integer, departureAirportCandidatesCount: integer, arrivalAirportCandidatesCount: integer &gt;&gt;&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  baseUrl = &quot;https://opensky-network.org/api/flights/departure&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nRetry = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  queryParameters = [{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    airport = &quot;LSZB&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin = 1641393602</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end = 1641483739</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    airport = &quot;EDDF&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin = 1641393602</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end = 1641483739</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  timeouts {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    connectionTimeoutMs = 200000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    readTimeoutMs = 200000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The Configuration for this new <code>ext-departures</code> includes the type of the DataObject, the expected schema, the base url from where we can fetch the departures from, the number of retries, a list of query parameters and timeout options.
To have more flexibility, we can now configure the query parameters as options instead defining them in the query string.<br>
<!-- -->The connection timeout corresponds to the time we wait until the connection is established and the read timeout equals the time we wait until the webservice responds after the request has been submitted.
If the request cannot be answered in the times configured, we try to automatically resend the request.
How many times a failed request will be resend, is controlled by the <code>nRetry</code> parameter.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>The <em>begin</em> and <em>end</em> can now be configured for each airport separatly.
The configuration expects unix timestamps, if you don&#x27;t know what that means, have a look at this <a href="https://www.unixtimestamp.com/" target="_blank" rel="noopener noreferrer">website</a>.
The webservice from opensky-network.org will not respond if the interval is larger than a week.
Hence, our <code>CustomWebserviceDataObject</code> will enforce the rule that if the chosen interval is larger, we query only the next four days given the <em>begin</em> configuration.</p></div></div><p>Note that we changed the type to <code>CustomWebserviceDataObject</code>.
This is a custom DataObject type, not included in standard Smart Data Lake Builder.
To make it work please go to the project&#x27;s root directory and <code>unzip part3.additional-files.zip</code> into the project&#x27;s root folder.
It includes the following file for you:</p><ul><li>./src/scala/io/smartdatalake/workflow/dataobject/CustomWebserviceDataObject.scala</li></ul><p>In this part we will work exclusively on the <code>CustomWebserviceDataObject.scala</code> file.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="define-action">Define Action<a class="hash-link" href="#define-action" title="Direct link to heading">​</a></h2><p>In the configuration we only change one action again:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">download-departures {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = CopyAction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inputId = ext-departures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outputId = stg-departures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  metadata {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    feed = download</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The type is no longer <code>FileTransferAction</code> but a <code>CopyAction</code> instead, as our new <code>CustomWebserviceDataObject</code> converts the Json-Output of the Webservice into a Spark DataFrame.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p><code>FileTransferAction</code>s are used, when your DataObjects reads an InputStream or writes an OutputStream like <code>WebserviceFileDataObject</code> or <code>SFtpFileRefDataObject</code>.
These transfer files one-to-one from input to output.<br>
<!-- -->More often you work with one of the many provided <code>SparkAction</code>s like the <code>CopyAction</code> shown here.
They work by using Spark Data Frames under the hood. </p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="try-it-out">Try it out<a class="hash-link" href="#try-it-out" title="Direct link to heading">​</a></h2><p>Compile and execute the code of this project with the following commands.
Note that parameter <code>--feed-sel</code> only selects <code>download-departures</code> as Action for execution. </p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Docker</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Podman</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mvnrepo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">project </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mvnrepo</span><span class="token operator" style="color:#393A34">:</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">mnt</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mvnrepo</span><span class="token plain"> maven</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.6</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">slim </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> mvn </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">project</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">xml</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-Dmaven.repo.local=/mnt/.mvnrepo&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">rm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config sdl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spark</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">feed</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">sel ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">download</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">departures</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mvnrepo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">podman run </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">project </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mvnrepo</span><span class="token operator" style="color:#393A34">:</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">mnt</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">mvnrepo</span><span class="token plain"> maven</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3.6</span><span class="token number" style="color:#36acaa">.0</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">jdk</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">11</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">slim </span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> mvn </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">project</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">xml</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-Dmaven.repo.local=/mnt/.mvnrepo&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">podman run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">rm </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">hostname</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">localhost </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">pod getting</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">started </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config sdl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spark</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">feed</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">sel ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">download</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">departures</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div><p>Nothing should have changed. You should again receive data as json files in the corresponding <code>stg-departures</code> folder.
But except of receiving the departures for only one airport, the DataObject returns the departures for all configured airports.
In this specific case this would be <em>LSZB</em> and <em>EDDF</em> within the corresponding time window.</p><p>Having a look at the log, something similar should appear on your screen. </p><div class="language-Bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:32 INFO  ActionDAGRun$ActionEventListener:228 - Action~download-departures[CopyAction]: Prepare started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:32 INFO  ActionDAGRun$ActionEventListener:237 - Action~download-departures[CopyAction]: Prepare succeeded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:32 INFO  ActionDAGRun$ActionEventListener:228 - Action~download-departures[CopyAction]: Init started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:33 INFO  CustomWebserviceDataObject:69 - Success for request https://opensky-network.org/api/flights/departure?airport=LSZB&amp;begin=1630200800&amp;end=1630310979</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:33 INFO  CustomWebserviceDataObject:69 - Success for request https://opensky-network.org/api/flights/departure?airport=EDDF&amp;begin=1630200800&amp;end=1630310979</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:35 INFO  ActionDAGRun$ActionEventListener:237 - Action~download-departures[CopyAction]: Init succeeded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:35 INFO  ActionDAGRun$ActionEventListener:228 - Action~download-departures[CopyAction]: Exec started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:35 INFO  CopyAction:158 - (Action~download-departures) getting DataFrame for DataObject~ext-departures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:36 INFO  CustomWebserviceDataObject:69 - Success for request https://opensky-network.org/api/flights/departure?airport=LSZB&amp;begin=1630200800&amp;end=1630310979</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2021-11-10 14:00:37 INFO  CustomWebserviceDataObject:69 - Success for request https://opensky-network.org/api/flights/departure?airport=EDDF&amp;begin=1630200800&amp;end=1630310979</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It is important to notice that the two requests for each airport to the API were not send only once, but twice.
This stems from the fact that the method <code>getSparkDataFrame</code> of the Data Object is called twice in the DAG execution of the Smart Data Lake Builder:
Once during the Init Phase and once again during the Exec Phase. See <a href="/docs/reference/executionPhases">this page</a> for more information on that.
Before we address and mitigate this behaviour in the next section, let&#x27;s have a look at the <code>getSparkDataFrame</code> method and the currently implemented logic:</p><div class="language-Scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// use the queryParameters from the config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val currentQueryParameters = checkQueryParameters(queryParameters)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// given the query parameters, generate all requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val departureRequests = currentQueryParameters.map(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  param =&gt; s&quot;${baseUrl}?airport=${param.airport}&amp;begin=${param.begin}&amp;end=${param.end}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// make requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val departuresResponses = departureRequests.map(request(_))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// create dataframe with the correct schema and add created_at column with the current timestamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">val departuresDf = departuresResponses.toDF(&quot;responseBinary&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .withColumn(&quot;responseString&quot;, byte2String($&quot;responseBinary&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .select(from_json($&quot;responseString&quot;, DataType.fromDDL(schema)).as(&quot;response&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .select(explode($&quot;response&quot;).as(&quot;record&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .select(&quot;record.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  .withColumn(&quot;created_at&quot;, current_timestamp())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">departuresDf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Given the configured query parameters, the requests are first prepared using the request method.
If you have a look at the implementation of the <code>request</code> method, you notice that we provide some ScalaJCustomWebserviceClient that is based on the <em>ScalaJ</em> library.
Also in the <code>request</code> method you can find the configuration for the number of retries.
Afterwards, we create a data frame out of the response.
We implemented some transformations to flatten the result returned by the API.<br>
<!-- -->Spark has lots of <em>Functions</em> that can be used out of the box.
We used such a column based function <em>from_json</em> to parse the response string with the right schema.
At the end we return the freshly created data frame <code>departuresDf</code>.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>The return type of the response is <code>Array[Byte]</code>. To convert that to <code>Array[String]</code> a <em>User Defined Function</em> (also called <em>UDF</em>) <code>byte2String</code> has been used, which is declared inside the getSparkDataFrame method.
This function is a nice example of how to write your own <em>UDF</em>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="get-data-frame">Get Data Frame<a class="hash-link" href="#get-data-frame" title="Direct link to heading">​</a></h2><p>In this section we will learn how we can avoid sending the request twice to the API using the execution phase information provided by the Smart Data Lake Builder.
We will now implement a simple <em>if ... else</em> statement that allows us to return an empty data frame with the correct schema in the <strong>Init</strong> phase and to only query the data in the <strong>Exec</strong> phase.
This logic is implemented in the next code snipped and should replace the code currently enclosed between the two <code>// REPLACE BLOCK</code> comments.</p><div class="language-Scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-Scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    if(context.phase == ExecutionPhase.Init){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // simply return an empty data frame</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Seq[String]().toDF(&quot;responseString&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .select(from_json($&quot;responseString&quot;, DataType.fromDDL(schema)).as(&quot;response&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .select(explode($&quot;response&quot;).as(&quot;record&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .select(&quot;record.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .withColumn(&quot;created_at&quot;, current_timestamp())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // use the queryParameters from the config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val currentQueryParameters = checkQueryParameters(queryParameters)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // given the query parameters, generate all requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val departureRequests = currentQueryParameters.map(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    param =&gt; s&quot;${baseUrl}?airport=${param.airport}&amp;begin=${param.begin}&amp;end=${param.end}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // make requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val departuresResponses = departureRequests.map(request(_))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // create dataframe with the correct schema and add created_at column with the current timestamp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  val departuresDf = departuresResponses.toDF(&quot;responseBinary&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .withColumn(&quot;responseString&quot;, byte2String($&quot;responseBinary&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .select(from_json($&quot;responseString&quot;, DataType.fromDDL(schema)).as(&quot;response&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .select(explode($&quot;response&quot;).as(&quot;record&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .select(&quot;record.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          .withColumn(&quot;created_at&quot;, current_timestamp())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // put simple nextState logic below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  departuresDf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note, in the <em>Init</em> phase, the pre-defined <strong>schema</strong> (see the <code>ext-departures</code> DataObject definition in the config) is used to create an empty/dummy json string, which then gets converted to the DataFrame.</p><p>Don&#x27;t be confused about some comments in the code. They will be used in the next chapter.
If you re-compile the code of this project and then restart the program with the previous commands
you should see that we do not query the API twice anymore.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>  Use the information of the <code>ExecutionPhase</code> in your custom implementations whenever you need to have different logic during the different phases.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="preserve-schema">Preserve schema<a class="hash-link" href="#preserve-schema" title="Direct link to heading">​</a></h2><p>With this implementation, we still write the Spark data frame of our <code>CustomWebserviceDataObject</code> in Json format.
As a consequence, we lose the schema definition when the data is read again.<br>
<!-- -->To improve this behaviour, let&#x27;s directly use the <code>ext-departures</code> as <em>inputId</em> in the <code>deduplicate-departures</code> action, and rename the Action as <code>download-deduplicate-departures</code>.
The deduplicate action expects a DataFrame as input. Since our <code>CustomWebserviceDataObject</code> delivers that, there is no need for an intermediate step anymore.<br>
<!-- -->After you&#x27;ve changed that, the first transformer has to be rewritten as well, since the input has changed.
Please replace it with the implementation below</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type = SQLDfTransformer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  code = &quot;select ext_departures.*, date_format(from_unixtime(firstseen),&#x27;yyyyMMdd&#x27;) dt from ext_departures&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The old Action <code>download-departures</code> and the DataObject <code>stg-departures</code> can be deleted, as it&#x27;s not needed anymore.</p><p>At the end, your config file should look something like <a target="_blank" href="/assets/files/application-part3-download-custom-webservice-8128471803017a347edd923edbae995f.conf">this</a> and the CustomWebserviceDataObject code like <a target="_blank" href="/assets/files/CustomWebserviceDataObject-1-b9264f59c390d53941ed1f8d9e0cf2fc.scala">this</a>.
Note that since we changed the file format to delta lake, your new <code>download-deduplicate-departures</code> feed now needs the metastore that you setup in part 2.
Therefore, you need to make sure that polynote and the metastore are running as shown in <a href="/docs/getting-started/part-2/delta-lake-format">the first step of part 2</a>.
Then, you need to delete the files in the data folder and then run the following command in another terminal: </p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Docker</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Podman</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">rm </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">network getting</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">started_default sdl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spark</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">feed</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">sel ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">download</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deduplicate</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">departures</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">f data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">podman run </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">rm </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">hostname</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">localhost </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">target</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">lib </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">v $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token constant" style="color:#36acaa">PWD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">pod getting</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">started sdl</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">spark</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">latest </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mnt</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">--</span><span class="token plain">feed</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">sel ids</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">download</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deduplicate</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">departures</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/smart-data-lake/smart-data-lake/tree/documentation/docs/getting-started/part-3/custom-webservice.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/getting-started/part-2/historical-data"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Keeping historical data</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/getting-started/part-3/incremental-mode"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Incremental Mode</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#goal" class="table-of-contents__link toc-highlight">Goal</a></li><li><a href="#starting-point" class="table-of-contents__link toc-highlight">Starting point</a></li><li><a href="#define-data-objects" class="table-of-contents__link toc-highlight">Define Data Objects</a></li><li><a href="#define-action" class="table-of-contents__link toc-highlight">Define Action</a></li><li><a href="#try-it-out" class="table-of-contents__link toc-highlight">Try it out</a></li><li><a href="#get-data-frame" class="table-of-contents__link toc-highlight">Get Data Frame</a></li><li><a href="#preserve-schema" class="table-of-contents__link toc-highlight">Preserve schema</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/">Getting started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/smart-data-lake/smart-data-lake" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/smart-data-lake/smart-data-lake/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.elca.ch" target="_blank" rel="noopener noreferrer" class="footer__link-item">ELCA<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Smart Data Lake, Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c7df9dc1.js"></script>
<script src="/assets/js/main.e0a979e5.js"></script>
</body>
</html>