"use strict";(self.webpackChunksmart_data_lake=self.webpackChunksmart_data_lake||[]).push([[6687],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return m}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),d=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=d(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(a),m=r,h=c["".concat(s,".").concat(m)]||c[m]||u[m]||i;return a?n.createElement(h,o(o({ref:t},p),{},{components:a})):n.createElement(h,o({ref:t},p))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},8215:function(e,t,a){var n=a(7294);t.Z=function(e){var t=e.children,a=e.hidden,r=e.className;return n.createElement("div",{role:"tabpanel",hidden:a,className:r},t)}},9877:function(e,t,a){a.d(t,{Z:function(){return p}});var n=a(7462),r=a(7294),i=a(2389),o=a(9548),l=a(6010),s="tabItem_LplD";function d(e){var t,a,i,d=e.lazy,p=e.block,u=e.defaultValue,c=e.values,m=e.groupId,h=e.className,f=r.Children.map(e.children,(function(e){if((0,r.isValidElement)(e)&&void 0!==e.props.value)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),k=null!=c?c:f.map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes}})),g=(0,o.lx)(k,(function(e,t){return e.value===t.value}));if(g.length>0)throw new Error('Docusaurus error: Duplicate values "'+g.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var b=null===u?u:null!=(t=null!=u?u:null==(a=f.find((function(e){return e.props.default})))?void 0:a.props.value)?t:null==(i=f[0])?void 0:i.props.value;if(null!==b&&!k.some((function(e){return e.value===b})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+b+'" but none of its children has the corresponding value. Available values are: '+k.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var v=(0,o.UB)(),y=v.tabGroupChoices,w=v.setTabGroupChoices,N=(0,r.useState)(b),D=N[0],C=N[1],T=[],_=(0,o.o5)().blockElementScrollPositionUntilNextRender;if(null!=m){var S=y[m];null!=S&&S!==D&&k.some((function(e){return e.value===S}))&&C(S)}var x=function(e){var t=e.currentTarget,a=T.indexOf(t),n=k[a].value;n!==D&&(_(t),C(n),null!=m&&w(m,n))},j=function(e){var t,a=null;switch(e.key){case"ArrowRight":var n=T.indexOf(e.currentTarget)+1;a=T[n]||T[0];break;case"ArrowLeft":var r=T.indexOf(e.currentTarget)-1;a=T[r]||T[T.length-1]}null==(t=a)||t.focus()};return r.createElement("div",{className:"tabs-container"},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":p},h)},k.map((function(e){var t=e.value,a=e.label,i=e.attributes;return r.createElement("li",(0,n.Z)({role:"tab",tabIndex:D===t?0:-1,"aria-selected":D===t,key:t,ref:function(e){return T.push(e)},onKeyDown:j,onFocus:x,onClick:x},i,{className:(0,l.Z)("tabs__item",s,null==i?void 0:i.className,{"tabs__item--active":D===t})}),null!=a?a:t)}))),d?(0,r.cloneElement)(f.filter((function(e){return e.props.value===D}))[0],{className:"margin-vert--md"}):r.createElement("div",{className:"margin-vert--md"},f.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==D})}))))}function p(e){var t=(0,i.Z)();return r.createElement(d,(0,n.Z)({key:String(t)},e))}},2549:function(e,t,a){a.r(t),a.d(t,{contentTitle:function(){return p},default:function(){return h},frontMatter:function(){return d},metadata:function(){return u},toc:function(){return c}});var n=a(7462),r=a(3366),i=(a(7294),a(3905)),o=a(9877),l=a(8215),s=["components"],d={title:"Keeping historical data"},p=void 0,u={unversionedId:"getting-started/part-2/historical-data",id:"getting-started/part-2/historical-data",title:"Keeping historical data",description:"Goal",source:"@site/docs/getting-started/part-2/historical-data.md",sourceDirName:"getting-started/part-2",slug:"/getting-started/part-2/historical-data",permalink:"/docs/getting-started/part-2/historical-data",editUrl:"https://github.com/smart-data-lake/smart-data-lake/tree/documentation/docs/getting-started/part-2/historical-data.md",tags:[],version:"current",frontMatter:{title:"Keeping historical data"},sidebar:"docs",previous:{title:"Delta Lake - a better data format",permalink:"/docs/getting-started/part-2/delta-lake-format"},next:{title:"Custom Webservice",permalink:"/docs/getting-started/part-3/custom-webservice"}},c=[{value:"Goal",id:"goal",children:[],level:2},{value:"Requirements",id:"requirements",children:[],level:2},{value:"Historization of airport data",id:"historization-of-airport-data",children:[],level:2},{value:"Deduplication of flight data",id:"deduplication-of-flight-data",children:[],level:2},{value:"Summary",id:"summary",children:[],level:2}],m={toc:c};function h(e){var t=e.components,d=(0,r.Z)(e,s);return(0,i.kt)("wrapper",(0,n.Z)({},m,d,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"goal"},"Goal"),(0,i.kt)("p",null,"Data generally can be split into two groups:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Master data:",(0,i.kt)("br",{parentName:"li"}),"data about objects that evolve over time, e.g. an airport, a person, a product... "),(0,i.kt)("li",{parentName:"ul"},"Transactional data:",(0,i.kt)("br",{parentName:"li"}),"data about events that took place at a certain point in time, e.g. a flight, a payment... ")),(0,i.kt)("p",null,"To keep historical data for both these categories, different strategies are applied:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Master data")," is most often ",(0,i.kt)("strong",{parentName:"li"},"historized"),' - this means tracking the evolution of objects over time by introducing a time dimension.\nUsually this is modelled with two additional attributes "valid_from" and "valid_to", where "valid_from" is an additional primary key column.'),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Transactional data")," is usually ",(0,i.kt)("strong",{parentName:"li"},"deduplicated"),", as only the latest state of a specific event is of interest. If an update for an event occurs, the previous information is discarded (or consolidated in special cases).\nAdditional care must be taken to keep all historical events, even if they are no longer present in the source system. Often specific housekeeping rules are applied (e.g. retention period), either for legal or cost saving reasons.")),(0,i.kt)("h2",{id:"requirements"},"Requirements"),(0,i.kt)("p",null,"For Historization and Deduplication a data pipeline needs to read the state of the output DataObject, merge it with the new state of the input DataObject and write the result to the output DataObject.\nTo read and write the same DataObject in the same SDL Action, this must be a transactional DataObject.\nIt means the DataObject must implement the interface TransactionalSparkTableDataObject of SDL.\nLuckily in the previous chapter we already upgraded our data pipeline to use DeltaLakeTableDataObject, which is a TransactionalSparkTableDataObject."),(0,i.kt)("p",null,"Further, we need a key to identify records for a specific object in our data, so we can build the time dimension or deduplicate records of the same object:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For airport masterdata (",(0,i.kt)("inlineCode",{parentName:"li"},"int_airports"),') the attribute "ident" clearly serves this purpose.'),(0,i.kt)("li",{parentName:"ul"},"For departure data (",(0,i.kt)("inlineCode",{parentName:"li"},"int_departures"),") it gets more complicated to identify a flight. To simplify, let's assume we're only interested in one flight per aircraft, departure airport and day.\nThe key would then be the attributes ",(0,i.kt)("inlineCode",{parentName:"li"},"icao24"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"estdepartureairport")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"trunc_date"),".")),(0,i.kt)("h2",{id:"historization-of-airport-data"},"Historization of airport data"),(0,i.kt)("p",null,"To historize airport master data, we have to adapt our configuration as follows:"),(0,i.kt)("p",null,"Add a primary key to the table definition of ",(0,i.kt)("inlineCode",{parentName:"p"},"int-airports"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'table {\n  db = "default"\n  name = "int_airports"\n  primaryKey = [ident]\n}\n')),(0,i.kt)("p",null,"Note, that a primary key can be a composite primary key, therefore you need to define an array of columns ",(0,i.kt)("inlineCode",{parentName:"p"},"[ident]"),"."),(0,i.kt)("p",null,"For the action ",(0,i.kt)("inlineCode",{parentName:"p"},"select-airport-cols"),", change it's type from ",(0,i.kt)("inlineCode",{parentName:"p"},"CopyAction")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"HistorizeAction"),".",(0,i.kt)("br",{parentName:"p"}),"\n","While you're at it, rename it to ",(0,i.kt)("inlineCode",{parentName:"p"},"historize-airports")," to reflect it's new function."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"historize-airports {\n  type = HistorizeAction\n  ...\n}\n")),(0,i.kt)("p",null,"With historization, this table will now get two additional columns called ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_captured")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_delimited"),".\nSchema evolution of existing tables will be explained later, so for now, just delete the table and it's data for the DataObject ",(0,i.kt)("inlineCode",{parentName:"p"},"int-airports")," through Polynote.\nTo access DataObjects from Polynote you need to first read SDL configuration into a registry, see Notebook ",(0,i.kt)("em",{parentName:"p"},"SelectingData")," chapter ",(0,i.kt)("em",{parentName:"p"},"Select data by using DataObjects configured in SmartDataLake"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'val dataIntAirports = registry.get[DeltaLakeTableDataObject]("int-airports")\ndataIntAirports.dropTable\n')),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Depending on your system setup, it's possible that Polynote is not allowed to drop the data of your table.\nIf you receive strange errors about dl_ts_captured and dl_ts_delimited not being found, please delete the folder data/int-airports/ manually."))),(0,i.kt)("p",null,"Then start Action ",(0,i.kt)("inlineCode",{parentName:"p"},"historize-airports"),".\nYou may have seen that the ",(0,i.kt)("inlineCode",{parentName:"p"},"--feed-sel")," parameter of SDL command line supports more options to select actions to execute (see command line help).\nWe will now only execute this single action by changing this parameter to ",(0,i.kt)("inlineCode",{parentName:"p"},"--feed-sel ids:historize-airports"),":"),(0,i.kt)(o.Z,{groupId:"docker-podman-switch",defaultValue:"docker",values:[{label:"Docker",value:"docker"},{label:"Podman",value:"podman"}],mdxType:"Tabs"},(0,i.kt)(l.Z,{value:"docker",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"docker run --rm -v ${PWD}/data:/mnt/data -v ${PWD}/target:/mnt/lib -v ${PWD}/config:/mnt/config --network getting-started_default sdl-spark:latest -c /mnt/config --feed-sel ids:historize-airports\n"))),(0,i.kt)(l.Z,{value:"podman",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"podman run --rm -v ${PWD}/data:/mnt/data -v ${PWD}/target:/mnt/lib -v ${PWD}/config:/mnt/config --pod getting-started sdl-spark:latest -c /mnt/config --feed-sel ids:historize-airports\n")))),(0,i.kt)("p",null,"After successful execution you can check the schema and data of our table in Polynote.\nIt now has a time dimension through the two new columns ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_captured")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_delimited"),".\nThey form a closed interval, meaning start and end time are inclusive.\nIt has millisecond precision, but the timestamp value is set to the current time of our data pipeline run.\nThe two attributes show the time period in which an object with this combination of attribute values has existed in our data source.\nThe sampling rate is given by the frequency that our data pipeline is scheduled."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"dataIntAirports.getDataFrame().printSchema\n\nroot\n|-- ident: string (nullable = true)\n|-- name: string (nullable = true)\n|-- latitude_deg: string (nullable = true)\n|-- longitude_deg: string (nullable = true)\n|-- dl_ts_captured: timestamp (nullable = true)\n|-- dl_ts_delimited: timestamp (nullable = true)\n")),(0,i.kt)("p",null,"If you look at the data, there should be only one record per object for now, as we didn't run our data pipeline with historical data yet."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'dataIntAirports.getDataFrame().orderBy($"ident",$"dl_ts_captured").show\n\n+-----+--------------------+------------------+-------------------+--------------------+-------------------+\n|ident|                name|      latitude_deg|      longitude_deg|      dl_ts_captured|    dl_ts_delimited|\n+-----+--------------------+------------------+-------------------+--------------------+-------------------+\n|  00A|   Total Rf Heliport|    40.07080078125| -74.93360137939453|2021-12-05 13:23:...|9999-12-31 00:00:00|\n| 00AA|Aero B Ranch Airport|         38.704022|        -101.473911|2021-12-05 13:23:...|9999-12-31 00:00:00|\n| 00AK|        Lowell Field|         59.947733|        -151.692524|2021-12-05 13:23:...|9999-12-31 00:00:00|\n| 00AL|        Epps Airpark| 34.86479949951172| -86.77030181884766|2021-12-05 13:23:...|9999-12-31 00:00:00|\n| 00AR|Newport Hospital ...|           35.6087|         -91.254898|2021-12-05 13:23:...|9999-12-31 00:00:00|\n...\n')),(0,i.kt)("p",null,"Let's try to simulate the historization process by loading a historical state of the data and see if any of the airports have changed since then.\nFor this, drop table ",(0,i.kt)("inlineCode",{parentName:"p"},"int-airports")," again.\nThen, delete all files in ",(0,i.kt)("inlineCode",{parentName:"p"},"data/stg-airport")," and copy the historical ",(0,i.kt)("inlineCode",{parentName:"p"},"result.csv")," from the folder ",(0,i.kt)("inlineCode",{parentName:"p"},"data-fallback-download/stg-airport")," into the folder ",(0,i.kt)("inlineCode",{parentName:"p"},"data/stg-aiport"),"."),(0,i.kt)("p",null,"Now start the action ",(0,i.kt)("inlineCode",{parentName:"p"},"historize-airports"),' (and only historize-airports) again to do an "initial load".\nRemember how you do that? That\'s right, you can define a single action with ',(0,i.kt)("inlineCode",{parentName:"p"},"--feed-sel ids:historize-airports"),".",(0,i.kt)("br",{parentName:"p"}),"\n","Afterwards, start actions ",(0,i.kt)("inlineCode",{parentName:"p"},"download-airports")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"historize-airports")," by using the parameter ",(0,i.kt)("inlineCode",{parentName:"p"},"--feed-sel 'ids:(download|historize)-airports'")," to download fresh data and build up the airport history."),(0,i.kt)("p",null,"Now check in Polynote again and you'll find several airports that have changed between the intitial and the current state:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'dataIntAirports.getDataFrame()\n.groupBy($"ident").count\n.orderBy($"count".desc)\n.show\n\n+-------+-----+\n|  ident|count|\n+-------+-----+\n|RU-4111|    2|\n|   LL33|    2|\n|   73CA|    2|\n|CA-0120|    2|\n|   CDV3|    2|\n...\n')),(0,i.kt)("p",null,"When checking the details it seems that for many airports the number of significant digits was reduced for the position:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'dataIntAirports.getDataFrame()\n.where($"ident"==="CDV3")\n.show(false)\n\n+-----+-------------------------------------------------+-------------+--------------+--------------------------+--------------------------+\n|ident|name                                             |latitude_deg |longitude_deg |dl_ts_captured            |dl_ts_delimited           |\n+-----+-------------------------------------------------+-------------+--------------+--------------------------+--------------------------+\n|CDV3 |Charlottetown (Queen Elizabeth Hospital) Heliport|46.255493    |-63.098887    |2021-12-05 20:52:58.800645|9999-12-31 00:00:00       |\n|CDV3 |Charlottetown (Queen Elizabeth Hospital) Heliport|46.2554925916|-63.0988866091|2021-12-05 20:40:31.629764|2021-12-05 20:52:58.799645|\n+-----+-------------------------------------------------+-------------+--------------+--------------------------+--------------------------+\n')),(0,i.kt)("p",null,"Values for ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_capture")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_delimited")," respectively were set to the current time of our data pipeline run.\nFor an initial load, this should be set to the time of the historical data set.\nCurrently, this is not possible in SDL, but there are plans to implement this, see issue ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/smart-data-lake/smart-data-lake/issues/427"},"#427"),"."),(0,i.kt)("p",null,"Now let's continue with flight data."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Spark performance")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Maybe you're under the impression that HistorizeAction runs quite long for a small amount of data.\nAnd you're right about that:",(0,i.kt)("br",{parentName:"p"}),"\n","On one side this is because in the background, it joins all existing data with the new input data and checks for changes.",(0,i.kt)("br",{parentName:"p"}),"\n","On the other side there is a Spark property we should tune for small datasets.\nIf Spark joins data, it needs two processing stages and a shuffle in between to do so (you can read more about this in various Spark tutorials).\nThe default value is to create 200 tasks in each shuffle. With our dataset, 2 tasks would be enough already.\nYou can tune this by setting the following property in global.spark-options of your application.conf:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre"},'"spark.sql.shuffle.partitions" = 2\n')),(0,i.kt)("p",{parentName:"div"},"Also, the algorithm to detect and merge changes can be optimized by using Delta formats merge capabilities. This will be covered in part three of this tutorial. "))),(0,i.kt)("h2",{id:"deduplication-of-flight-data"},"Deduplication of flight data"),(0,i.kt)("p",null,"To deduplicate departure flight data, we have to adapt our configuration as follows:"),(0,i.kt)("p",null,"Add a primary key to the table definition of ",(0,i.kt)("inlineCode",{parentName:"p"},"int-departures"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'table {\n  db = "default"\n  name = "int_departures"\n  primaryKey = [icao24, estdepartureairport, dt]\n}\n')),(0,i.kt)("p",null,"Change the type of action ",(0,i.kt)("inlineCode",{parentName:"p"},"prepare-departures")," from ",(0,i.kt)("inlineCode",{parentName:"p"},"CopyAction"),", this time to ",(0,i.kt)("inlineCode",{parentName:"p"},"DeduplicateAction")," and rename it to ",(0,i.kt)("inlineCode",{parentName:"p"},"deduplicate-departures"),", again to reflect its new type.\nIt also needs an additional transformer to calculate the new primary key column ",(0,i.kt)("inlineCode",{parentName:"p"},"dt")," derived from the column ",(0,i.kt)("inlineCode",{parentName:"p"},"firstseen"),".\nSo make sure to add these lines too: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"deduplicate-departures {\n  type = DeduplicateAction\n  ...\n  transformers = [{\n    type = SQLDfTransformer\n    code = \"select stg_departures.*, date_format(from_unixtime(firstseen),'yyyyMMdd') dt from stg_departures\"\n  }]\n  ...\n}\n")),(0,i.kt)("p",null,"Now, delete the table and data of the DataObject ",(0,i.kt)("inlineCode",{parentName:"p"},"int-departures")," in Polynote, to prepare it for the new columns ",(0,i.kt)("inlineCode",{parentName:"p"},"dt")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_captured"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'val dataIntDepartures = registry.get[DeltaLakeTableDataObject]("int-departures")\ndataIntDepartures.dropTable\n')),(0,i.kt)("p",null,"Then start Action deduplicate-departures:"),(0,i.kt)(o.Z,{groupId:"docker-podman-switch",defaultValue:"docker",values:[{label:"Docker",value:"docker"},{label:"Podman",value:"podman"}],mdxType:"Tabs"},(0,i.kt)(l.Z,{value:"docker",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"docker run --rm -v ${PWD}/data:/mnt/data -v ${PWD}/target:/mnt/lib -v ${PWD}/config:/mnt/config --network getting-started_default sdl-spark:latest -c /mnt/config --feed-sel ids:deduplicate-departures\n"))),(0,i.kt)(l.Z,{value:"podman",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},"podman run --rm -v ${PWD}/data:/mnt/data -v ${PWD}/target:/mnt/lib -v ${PWD}/config:/mnt/config --pod getting-started sdl-spark:latest -c /mnt/config --feed-sel ids:deduplicate-departures\n")))),(0,i.kt)("p",null,"After successful execution you can check the schema and data of our table in Polynote.\nThe new column ",(0,i.kt)("inlineCode",{parentName:"p"},"dl_ts_captured")," shows the current time of the data pipeline run when this object first occurred in the input data. "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"dataIntDepartures.getDataFrame().printSchema\n\nroot\n|-- arrivalairportcandidatescount: long (nullable = true)\n|-- callsign: string (nullable = true)\n|-- departureairportcandidatescount: long (nullable = true)\n|-- estarrivalairport: string (nullable = true)\n|-- estarrivalairporthorizdistance: long (nullable = true)\n|-- estarrivalairportvertdistance: long (nullable = true)\n|-- estdepartureairport: string (nullable = true)\n|-- estdepartureairporthorizdistance: long (nullable = true)\n|-- estdepartureairportvertdistance: long (nullable = true)\n|-- firstseen: long (nullable = true)\n|-- icao24: string (nullable = true)\n|-- lastseen: long (nullable = true)\n|-- dt: string (nullable = true)\n|-- dl_ts_captured: timestamp (nullable = true)\n")),(0,i.kt)("p",null,"We can check the work of DeduplicateAction by the following query in Polynote: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'dataIntDepartures.getDataFrame()\n.groupBy($"icao24", $"estdepartureairport", $"dt")\n.count\n.orderBy($"count".desc)\n.show\n\n+------+-------------------+--------+-----+\n|icao24|estdepartureairport|      dt|count|\n+------+-------------------+--------+-----+\n|4b43ab|               LSZB|20210829|    3|\n|4b4b8d|               LSZB|20210829|    3|\n|4b1b13|               LSZB|20210829|    2|\n|4b4445|               LSZB|20210829|    2|\n|4b0f70|               LSZB|20210830|    1|\n|4b1a01|               LSZB|20210829|    1|\n|346603|               LSZB|20210829|    1|\n|4b4442|               LSZB|20210829|    1|\n|4d02d7|               LSZB|20210829|    1|\n|4b43ab|               LSZB|20210830|    1|\n...\n')),(0,i.kt)("p",null,"... and it seems that it did not work properly! There are 2 or even 3 records for the same primary key!\nEven worse, we just deleted this table before, so DeduplicateAction shouldn't have any work to do at all."),(0,i.kt)("p",null,"In fact DeduplicateAction assumes that input data is already unique for the given primary key.\nThis would be the case for example, in a messaging context, if you were to receive the same message twice.\nDeduplicateAction doesn't deduplicate your input data again, because deduplication is costly and data often is already unique.\nBut in our example we have duplicates in the input data set, and we need to add some deduplication logic to our input data (this will probably become a configuration flag in future SDL version, see issue ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/smart-data-lake/smart-data-lake/issues/428"},"#428"),")."),(0,i.kt)("p",null,"As the easiest way to do this is by using the Scala Spark API, we will add a second ScalaCodeDfTransformer as follows (make sure you get the brackets right): "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'deduplicate-departures {\n  type = DeduplicateAction\n  ...\n  transformers = [{\n    type = SQLDfTransformer\n    code = "select stg_departures.*, date_format(from_unixtime(firstseen),\'yyyyMMdd\') dt from stg_departures"\n  },{\n    type = ScalaCodeDfTransformer\n    code = """\n      import org.apache.spark.sql.{DataFrame, SparkSession}\n      def transform(session: SparkSession, options: Map[String,String], df: DataFrame, dataObjectId: String) : DataFrame = {\n        import session.implicits._\n        df.dropDuplicates("icao24", "estdepartureairport", "dt")\n      }\n      // return as function\n      transform _\n    """\n  }]\n  ...\n}\n')),(0,i.kt)("p",null,"If you run Action ",(0,i.kt)("inlineCode",{parentName:"p"},"deduplicate-departures")," again and check the result in Polynote, everything is fine now."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Note how we have used a third way of defining transformation logic now:",(0,i.kt)("br",{parentName:"p"}),"\n","In part 1 we first used a SQLDfsTransformer writing SQL code.",(0,i.kt)("br",{parentName:"p"}),"\n","Then for the more complex example of computing distances, we used a  ScalaClassDfTransformer pointing to a Scala class.",(0,i.kt)("br",{parentName:"p"}),"\n","Here, we simply include Scala code in our configuration file directly."))),(0,i.kt)("p",null,"For sure DeduplicateAction did not have much work to do, as this was the first data load.\nIn order to get different data you would need to adjust the unix timestamp parameters in the URL of DataObject ",(0,i.kt)("inlineCode",{parentName:"p"},"ext-departures"),".\nFeel free to play around."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Scala Code")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Scala is a compiled language. The compiler creates bytecode which can be run on a JVM.\nNormally compilation takes place before execution. So how does it work with scala code in the configuration as in our deduplication logic above?"),(0,i.kt)("p",{parentName:"div"},"With Scala, you can compile code on the fly. This is actually what the Scala Shell/REPL is doing as well.\nThe Scala code in the configuration above gets compiled when ScalaCodeDfTransformer is instantiated during startup of SDL."))),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,"You have now seen different parts of industrializing a data pipeline like robust data formats and caring about historical data.\nFurther, you have explored data interactively with a notebook. "),(0,i.kt)("p",null,"The final configuration file of Part 2 should look like ",(0,i.kt)("a",{target:"_blank",href:a(4336).Z},"this")),(0,i.kt)("p",null,"In part 3 we will see how to incrementally load fresh flight data and optimize deduplication and historization.\nSee you!"))}h.isMDXComponent=!0},4336:function(e,t,a){t.Z=a.p+"assets/files/application-part2-historical-843a2c2778f891966427eaf1258fa99e.conf"}}]);